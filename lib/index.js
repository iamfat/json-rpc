"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};function t(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))}function n(e,t){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function c(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}function r(e,t){var n,r;if(0===t.length)return e;for(n=0,r=t.length;n<r;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e<0?-2*e:e}function o(e,t,n,s){var i,c=r(r(r(e,n),(i=t,Object.prototype.toString.call(i))),typeof t);if(null===t)return r(c,"null");if(void 0===t)return r(c,"undefined");if("object"==typeof t||"function"==typeof t){if(-1!==s.indexOf(t))return r(c,"[Circular]"+n);s.push(t);var a=function(e,t,n){return Object.keys(t).sort().reduce((function(e,r){return o(e,t[r],r,n)}),e)}(c,t,s);if(!("valueOf"in t)||"function"!=typeof t.valueOf)return a;try{return r(a,String(t.valueOf()))}catch(e){return r(a,"[valueOf exception]"+(e.stack||e.message))}}return r(c,t.toString())}var s=function(e){return function(e,t){for(;e.length<t;)e="0"+e;return e}(o(0,e,"",[]).toString(16),8)};let i=(e=21)=>{let t="",n=e;for(;n--;)t+="_-0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[64*Math.random()|0];return t};var c=function(t){function n(e,n){var r=t.call(this,e)||this;return r.code=n||0,r.message=e,r}return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(n,t),n.prototype.toString=function(){return this.message},n}(Error),a=function(){function e(e,r){var o=this;void 0===r&&(r=5e3),this._timeout=5e3,this._promises=new Map,this._callings=new Map,this._patterns=[],this._hashedFunctions=new Map,this._remoteObjects=new Map,this._remoteObjectClusters=new Map,this.extendedRPCs=[],this.send=e,this._timeout=r||5e3,this.on("_.Function.call",(function(e,r){return t(o,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return this._hashedFunctions.has(e)?(t=this._hashedFunctions.get(e),[4,Promise.resolve(t.apply(void 0,r))]):[3,2];case 1:return[2,n.sent()];case 2:return[2]}}))}))})),this.on("_.Function.release",(function(e){o._hashedFunctions.has(e)&&o._hashedFunctions.delete(e)})),this.on("_.RemoteObject.set",(function(e,t,n){try{for(var r=o._remoteObjects.get(e),s=t.split("."),i=s.pop(),c=r,a=0,u=s;a<u.length;a++){var l=u[a];c=Reflect.get(c,l)}Reflect.set(c,i,n)}catch(e){console.debug(e)}})),this.on("_.RemoteObject.get",(function(e){return t(o,void 0,void 0,(function(){var t,r,o,s,i,c;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),t=this._remoteObjects.get(e),o=(r=JSON).parse,i=(s=JSON).stringify,[4,Promise.resolve(t)];case 1:return[2,o.apply(r,[i.apply(s,[n.sent()])])];case 2:return c=n.sent(),console.debug(c),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.apply",(function(e,r,s){return t(o,void 0,void 0,(function(){var t,o,i,c,a,u,l,f,h;return n(this,(function(n){switch(n.label){case 0:for(n.trys.push([0,2,,3]),t=this._remoteObjects.get(e),o=void 0,i=void 0,"$"===r.slice(-1)?(i=r.slice(0,-1).split("."),o=!0):(i=r.split("."),o=!1),c=i.pop(),a=t,u=0,l=i;u<l.length;u++)f=l[u],a=Reflect.get(a,f);return[4,Promise.resolve(Reflect.apply(a[c],a,s))];case 1:return h=n.sent(),o?[2,JSON.parse(JSON.stringify(h))]:[2,this.makeRemoteObject(h,e)];case 2:return n.sent(),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.release",(function(e){return(o._remoteObjectClusters.get(e)||[]).map((function(e){return o._remoteObjects.delete(e)})),o._remoteObjectClusters.delete(e),!0}))}return e.prototype.decodeFunctions=function(e){var t=this,n=function(e){if(e===Object(e)){if("1.0"===e["@func"]&&Reflect.has(e,"hash"))return new Proxy((function(){}),{get:function(n,r){var o=String(r);return Reflect.has(n,r)?n[r]:"release"===o?function(){t.notify("_.Function.release",[e.hash])}:void 0},apply:function(n,r,o){t.notify("_.Function.call",[e.hash,o])}});for(var r in e)e.hasOwnProperty(r)&&(e[r]=n(e[r]))}else if(Array.isArray(e))return e.map((function(e){return n(e)}));return e};return n(e)},e.prototype.encodeFunctions=function(e){var t=this,n=function(e){if("function"==typeof e){var r=s(e);return t._hashedFunctions.set(r,e),{"@func":"1.0",hash:r}}if(e===Object(e))for(var o in e)e.hasOwnProperty(o)&&(e[o]=n(e[o]));else if(Array.isArray(e))return e.map((function(e){return n(e)}));return e};return n(e)},e.prototype.makeRemoteObject=function(e,t){var n=i();this._remoteObjects.set(n,e);var r=t||n,o=this._remoteObjectClusters.get(r)||[];return o.push(n),this._remoteObjectClusters.set(r,o),{"@remote":n}},e.prototype.extends=function(e){this.extendedRPCs.push(e)},e.prototype.getHandler=function(e){var t,n;if(this._callings.has(e))t=this._callings.get(e);else for(var r=0,o=this._patterns;r<o.length;r++){var s=o[r],i=s.pattern,c=s.callback;if(n=e.match(i)){t=c;break}}return[t,n]},e.prototype.receive=function(e){return t(this,void 0,void 0,(function(){var t,r,o,s,i,a,u,l,f,h,p,d,m,y,v,b,_;return n(this,(function(n){switch(n.label){case 0:if("2.0"!==e.jsonrpc)return[2,!1];if(!Reflect.has(e,"method"))return[3,5];if(t=e.method,r=e.params,o=void 0,"$"===t.slice(-1)?(t=t.slice(0,-1),o=!0):o=!1,s=this.getHandler(t),i=s[0],a=s[1],void 0===i&&this.extendedRPCs.length>0)for(u=0,l=this.extendedRPCs;u<l.length&&(f=l[u],_=f.getHandler(t),i=_[0],a=_[1],!i);u++);if(void 0===i)return e.id&&this.sendError(new c('Method "'+t+'" not found',-32601),e.id),[2];r=this.decodeFunctions(r),Array.isArray(r)||(r=[r]),n.label=1;case 1:return n.trys.push([1,3,,4]),d=void 0,a&&(r=[r,a]),[4,Promise.resolve(i.apply(void 0,r))];case 2:return d=n.sent(),o&&(d=this.makeRemoteObject(d)),e.id?[2,this.sendResult(d,e.id)]:[3,4];case 3:if((h=n.sent())instanceof c)return[2,this.sendError(h)];throw h;case 4:return[3,6];case 5:Reflect.has(e,"error")?e.id&&this._promises.has(e.id)&&((p=this._promises.get(e.id)).reject(e.error),clearTimeout(p.timeout),this._promises.delete(e.id)):Reflect.has(e,"result")&&e.id&&this._promises.has(e.id)&&(p=this._promises.get(e.id),(d=e.result)&&"object"==typeof d&&Reflect.has(d,"@remote")&&(m=this,y=d["@remote"],v={set:function(e,t,n){var r=String(t),o=e.$$baseName?e.$$baseName+"."+r:r;return m.call("_.RemoteObject.set",[y,o,n]),!0},get:function(e,t){var n=String(t);if("then"!==n&&"$$"!==n.slice(0,1))return Reflect.has(e,t)?e[t]:(Reflect.has(e.$$cache,t)||(e.$$cache[t]=new Proxy(Object.assign((function(){}),{$$baseName:e.$$baseName?e.$$baseName+"."+n:n,$$cache:{}}),v)),e.$$cache[t])},apply:function(e,t,n){return m.call("_.RemoteObject.apply",[y,e.$$baseName,n])}},b={},d=new Proxy(Object.assign((function(){}),{$$cache:b,release$:function(){return Object.keys(b).forEach((function(e){return delete b[e]})),m.call("_.RemoteObject.release",[y])},get$:function(){return m.call("_.RemoteObject.get",[y])}}),v)),p.resolve(d),clearTimeout(p.timeout),this._promises.delete(e.id)),n.label=6;case 6:return[2]}}))}))},e.prototype.sendResult=function(e,t){var n={jsonrpc:"2.0",result:e||null};return t&&(n.id=t),this.send(n),this},e.prototype.sendError=function(e,t){var n={jsonrpc:"2.0",error:{code:e.code,message:e.message}};return t&&(n.id=t),this.send(n),this},e.prototype.notify=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t),this.send({jsonrpc:"2.0",method:e,params:t})},e.prototype.call=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t);var n=this;return new Promise((function(r,o){var s=i(),a={id:s,jsonrpc:"2.0",method:e,params:t};n.send(a),n._promises.set(s,{resolve:r,reject:o,timeout:setTimeout((function(){n._promises.delete(s),o(new c("Call "+e+" Timeout",-32603))}),n._timeout)})}))},e.prototype.on=function(e,t){return"string"!=typeof e?this._patterns.push({pattern:e,callback:t}):this._callings.set(e,t),this},e.prototype.off=function(e){if("string"!=typeof e){for(var t in this._callings.keys())null!=t.match(e)&&this._callings.delete(t);var n=e.toString();this._patterns=this._patterns.filter((function(e){return e.pattern.toString()!==n}))}else this._callings.has(e)&&this._callings.delete(e);return this},e.Error=c,e}();module.exports=a;
