"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var nanoid=_interopDefault(require("nanoid/non-secure")),hash_sum=_interopDefault(require("hash-sum")),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function __awaiter(e,t,r,n){return new(r||(r=Promise))((function(s,o){function i(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new r((function(t){t(e.value)})).then(i,a)}c((n=n.apply(e,t||[])).next())}))}function __generator(e,t){var r,n,s,o,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(s=2&o[0]?n.return:o[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,o[1])).done)return s;switch(n=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(s=(s=i.trys).length>0&&s[s.length-1])&&(6===o[0]||2===o[0])){i=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){i.label=o[1];break}if(6===o[0]&&i.label<s[1]){i.label=s[1],s=o;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(o);break}s[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{r=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var RPCError=function(e){function t(t,r){var n=e.call(this)||this;return n.code=r||0,n.message=t,n}return __extends(t,e),t.prototype.toString=function(){return this.message},t}(Error),RPC=function(){function e(e,t){var r=this;void 0===t&&(t=5e3),this._timeout=5e3,this._promises=new Map,this._callings=new Map,this._patterns=[],this._hashedFunctions=new Map,this._remoteObjects=new Map,this._remoteObjectClusters=new Map,this.extendedRPCs=[],this.send=e,this._timeout=t||5e3,this.on("_.Function.call",(function(e,t){return __awaiter(r,void 0,void 0,(function(){var r;return __generator(this,(function(n){switch(n.label){case 0:return this._hashedFunctions.has(e)?(r=this._hashedFunctions.get(e),[4,Promise.resolve(r.apply(void 0,t))]):[3,2];case 1:return[2,n.sent()];case 2:return[2]}}))}))})),this.on("_.Function.release",(function(e){r._hashedFunctions.has(e)&&r._hashedFunctions.delete(e)})),this.on("_.RemoteObject.set",(function(e,t,n){try{for(var s=r._remoteObjects.get(e),o=t.split("."),i=o.pop(),a=s,c=0,u=o;c<u.length;c++){var l=u[c];a=Reflect.get(a,l)}Reflect.set(a,i,n)}catch(e){console.debug(e)}})),this.on("_.RemoteObject.get",(function(e){return __awaiter(r,void 0,void 0,(function(){var t,r,n,s,o,i;return __generator(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),t=this._remoteObjects.get(e),n=(r=JSON).parse,o=(s=JSON).stringify,[4,Promise.resolve(t)];case 1:return[2,n.apply(r,[o.apply(s,[a.sent()])])];case 2:return i=a.sent(),console.debug(i),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.apply",(function(e,t,n){return __awaiter(r,void 0,void 0,(function(){var r,s,o,i,a,c,u,l,h;return __generator(this,(function(f){switch(f.label){case 0:for(f.trys.push([0,2,,3]),r=this._remoteObjects.get(e),s=void 0,o=void 0,"$"===t.slice(-1)?(o=t.slice(0,-1).split("."),s=!0):(o=t.split("."),s=!1),i=o.pop(),a=r,c=0,u=o;c<u.length;c++)l=u[c],a=Reflect.get(a,l);return[4,Promise.resolve(Reflect.apply(a[i],a,n))];case 1:return h=f.sent(),s?[2,JSON.parse(JSON.stringify(h))]:[2,this.makeRemoteObject(h,e)];case 2:return f.sent(),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.release",(function(e){return(r._remoteObjectClusters.get(e)||[]).map((function(e){return r._remoteObjects.delete(e)})),r._remoteObjectClusters.delete(e),!0}))}return e.prototype.decodeFunctions=function(e){var t=this,r=function(e){if(e===Object(e)){if("1.0"===e["@func"]&&Reflect.has(e,"hash"))return new Proxy((function(){}),{get:function(r,n){var s=String(n);return Reflect.has(r,n)?r[n]:"release"===s?function(){t.notify("_.Function.release",[e.hash])}:void 0},apply:function(r,n,s){t.notify("_.Function.call",[e.hash,s])}});for(var n in e)e.hasOwnProperty(n)&&(e[n]=r(e[n]))}else if(Array.isArray(e))return e.map((function(e){return r(e)}));return e};return r(e)},e.prototype.encodeFunctions=function(e){var t=this,r=function(e){if("function"==typeof e){var n=hash_sum(e);return t._hashedFunctions.set(n,e),{"@func":"1.0",hash:n}}if(e===Object(e))for(var s in e)e.hasOwnProperty(s)&&(e[s]=r(e[s]));else if(Array.isArray(e))return e.map((function(e){return r(e)}));return e};return r(e)},e.prototype.makeRemoteObject=function(e,t){var r=nanoid();this._remoteObjects.set(r,e);var n=t||r,s=this._remoteObjectClusters.get(n)||[];return s.push(r),this._remoteObjectClusters.set(n,s),{"@remote":r}},e.prototype.extends=function(e){this.extendedRPCs.push(e)},e.prototype.getHandler=function(e){var t,r;if(this._callings.has(e))t=this._callings.get(e);else for(var n=0,s=this._patterns;n<s.length;n++){var o=s[n],i=o.pattern,a=o.callback;if(r=e.match(i)){t=a;break}}return[t,r]},e.prototype.receive=function(e){return __awaiter(this,void 0,void 0,(function(){var t,r,n,s,o,i,a,c,u,l,h,f,p,d,_,m,y;return __generator(this,(function(v){switch(v.label){case 0:if("2.0"!==e.jsonrpc)return[2,!1];if(!Reflect.has(e,"method"))return[3,5];if(t=e.method,r=e.params,n=void 0,"$"===t.slice(-1)?(t=t.slice(0,-1),n=!0):n=!1,s=this.getHandler(t),o=s[0],i=s[1],void 0===o&&this.extendedRPCs.length>0)for(a=0,c=this.extendedRPCs;a<c.length&&(u=c[a],y=u.getHandler(t),o=y[0],i=y[1],!o);a++);if(void 0===o)return e.id&&this.sendError(new RPCError('Method "'+t+'" not found',-32601),e.id),[2];r=this.decodeFunctions(r),Array.isArray(r)||(r=[r]),v.label=1;case 1:return v.trys.push([1,3,,4]),f=void 0,i&&(r=[r,i]),[4,Promise.resolve(o.apply(void 0,r))];case 2:return f=v.sent(),n&&(f=this.makeRemoteObject(f)),e.id?[2,this.sendResult(f,e.id)]:[3,4];case 3:if((l=v.sent())instanceof RPCError)return[2,this.sendError(l)];throw l;case 4:return[3,6];case 5:Reflect.has(e,"error")?e.id&&this._promises.has(e.id)&&((h=this._promises.get(e.id)).reject(e.error),clearTimeout(h.timeout),this._promises.delete(e.id)):Reflect.has(e,"result")&&e.id&&this._promises.has(e.id)&&(h=this._promises.get(e.id),(f=e.result)&&"object"==typeof f&&Reflect.has(f,"@remote")&&(p=this,d=f["@remote"],_={set:function(e,t,r){var n=String(t),s=e.$$baseName?e.$$baseName+"."+n:n;return p.call("_.RemoteObject.set",[d,s,r]),!0},get:function(e,t){var r=String(t);if("then"!==r&&"$$"!==r.slice(0,1))return Reflect.has(e,t)?e[t]:(Reflect.has(e.$$cache,t)||(e.$$cache[t]=new Proxy(Object.assign((function(){}),{$$baseName:e.$$baseName?e.$$baseName+"."+r:r,$$cache:{}}),_)),e.$$cache[t])},apply:function(e,t,r){return p.call("_.RemoteObject.apply",[d,e.$$baseName,r])}},m={},f=new Proxy(Object.assign((function(){}),{$$cache:m,release$:function(){return Object.keys(m).forEach((function(e){return delete m[e]})),p.call("_.RemoteObject.release",[d])},get$:function(){return p.call("_.RemoteObject.get",[d])}}),_)),h.resolve(f),clearTimeout(h.timeout),this._promises.delete(e.id)),v.label=6;case 6:return[2]}}))}))},e.prototype.sendResult=function(e,t){var r={jsonrpc:"2.0",result:e||null};return t&&(r.id=t),this.send(r),this},e.prototype.sendError=function(e,t){var r={jsonrpc:"2.0",error:{code:e.code,message:e.message}};return t&&(r.id=t),this.send(r),this},e.prototype.notify=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t),this.send({jsonrpc:"2.0",method:e,params:t})},e.prototype.call=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t);var r=this;return new Promise((function(n,s){var o=nanoid(),i={id:o,jsonrpc:"2.0",method:e,params:t};r.send(i),r._promises.set(o,{resolve:n,reject:s,timeout:setTimeout((function(){r._promises.delete(o),s(new RPCError("Call "+e+" Timeout",-32603))}),r._timeout)})}))},e.prototype.on=function(e,t){return"string"!=typeof e?this._patterns.push({pattern:e,callback:t}):this._callings.set(e,t),this},e.prototype.off=function(e){if("string"!=typeof e){for(var t in this._callings.keys())null!=t.match(e)&&this._callings.delete(t);var r=e.toString();this._patterns=this._patterns.filter((function(e){return e.pattern.toString()!==r}))}else this._callings.has(e)&&this._callings.delete(e);return this},e.Error=RPCError,e}();module.exports=RPC;
