"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("tslib"),t=require("hash-sum"),s=require("nanoid/non-secure");class i extends Error{constructor(e,t){super(e),this.code=t||0,this.message=e}toString(){return this.message}}class r{constructor(t,s=5e3){this._timeout=5e3,this._promises=new Map,this._callings=new Map,this._patterns=[],this._hashedFunctions=new Map,this._remoteObjects=new Map,this._remoteObjectClusters=new Map,this.extendedRPCs=[],this.send=t,this._timeout=s||5e3,this.on("_.Function.call",(t,s)=>e.__awaiter(this,void 0,void 0,(function*(){if(this._hashedFunctions.has(t)){let e=this._hashedFunctions.get(t);return yield Promise.resolve(e(...s))}}))),this.on("_.Function.release",e=>{this._hashedFunctions.has(e)&&this._hashedFunctions.delete(e)}),this.on("_.RemoteObject.set",(e,t,s)=>{try{const i=this._remoteObjects.get(e),r=t.split("."),o=r.pop();let n=i;for(let e of r)n=Reflect.get(n,e);Reflect.set(n,o,s)}catch(e){console.debug(e)}}),this.on("_.RemoteObject.get",t=>e.__awaiter(this,void 0,void 0,(function*(){try{const e=this._remoteObjects.get(t);return JSON.parse(JSON.stringify(yield Promise.resolve(e)))}catch(e){console.debug(e)}}))),this.on("_.RemoteObject.apply",(t,s,i)=>e.__awaiter(this,void 0,void 0,(function*(){try{const e=this._remoteObjects.get(t);let r,o;"$"===s.slice(-1)?(o=s.slice(0,-1).split("."),r=!0):(o=s.split("."),r=!1);const n=o.pop();let c=e;for(let e of o)c=Reflect.get(c,e);let a=yield Promise.resolve(Reflect.apply(c[n],c,i));return r?JSON.parse(JSON.stringify(a)):this.makeRemoteObject(a,t)}catch(e){}}))),this.on("_.RemoteObject.release",e=>((this._remoteObjectClusters.get(e)||[]).map(e=>this._remoteObjects.delete(e)),this._remoteObjectClusters.delete(e),!0))}decodeFunctions(e){const t=this,s=e=>{if(e===Object(e)){if("1.0"===e["@func"]&&Reflect.has(e,"hash"))return new Proxy(()=>{},{get(s,i){const r=String(i);return Reflect.has(s,i)?s[i]:"release"===r?()=>{t.notify("_.Function.release",[e.hash])}:void 0},apply(s,i,r){t.notify("_.Function.call",[e.hash,r])}});for(let t in e)e.hasOwnProperty(t)&&(e[t]=s(e[t]))}else if(Array.isArray(e))return e.map(e=>s(e));return e};return s(e)}encodeFunctions(e){const s=e=>{if("function"==typeof e){let s=t(e);return this._hashedFunctions.set(s,e),{"@func":"1.0",hash:s}}if(e===Object(e))for(let t in e)e.hasOwnProperty(t)&&(e[t]=s(e[t]));else if(Array.isArray(e))return e.map(e=>s(e));return e};return s(e)}makeRemoteObject(e,t){const i=s.nanoid();this._remoteObjects.set(i,e);const r=t||i,o=this._remoteObjectClusters.get(r)||[];return o.push(i),this._remoteObjectClusters.set(r,o),{"@remote":i}}extends(e){this.extendedRPCs.push(e)}getHandler(e){let t,s;if(this._callings.has(e))t=this._callings.get(e);else for(let{pattern:i,callback:r}of this._patterns)if(s=e.match(i),s){t=r;break}return[t,s]}receive(t){return e.__awaiter(this,void 0,void 0,(function*(){if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return void this.sendError(new i("Parse error",-32700))}if("2.0"===t.jsonrpc){if(Reflect.has(t,"method")){let e,{method:s,params:r}=t;"$"===s.slice(-1)?(s=s.slice(0,-1),e=!0):e=!1;let[o,n]=this.getHandler(s);if(void 0===o&&this.extendedRPCs.length>0)for(let e of this.extendedRPCs)if([o,n]=e.getHandler(s),o)break;if(void 0===o)return void(t.id&&this.sendError(new i(`Method "${s}" not found`,-32601),t.id));r=this.decodeFunctions(r),Array.isArray(r)||(r=[r]);try{let s;n&&(r=[r,n]),s=yield Promise.resolve(o(...r)),e&&(s=this.makeRemoteObject(s)),t.id&&this.sendResult(s,t.id)}catch(e){if(!(e instanceof i))throw e;this.sendError(e,t.id)}}else if(Reflect.has(t,"error")){if(t.id&&this._promises.has(t.id)){let e=this._promises.get(t.id);e.reject(t.error),clearTimeout(e.timeout),this._promises.delete(t.id)}}else if(Reflect.has(t,"result")&&t.id&&this._promises.has(t.id)){let e=this._promises.get(t.id),s=t.result;if(s&&"object"==typeof s&&Reflect.has(s,"@remote")){const e=this,t=s["@remote"],i={set(s,i,r){const o=String(i),n=s.$$baseName?`${s.$$baseName}.${o}`:o;return e.call("_.RemoteObject.set",[t,n,r]),!0},get(e,t){const s=String(t);if("then"!==s&&"$$"!==s.slice(0,1))return Reflect.has(e,t)?e[t]:(Reflect.has(e.$$cache,t)||(e.$$cache[t]=new Proxy(Object.assign(()=>{},{$$baseName:e.$$baseName?`${e.$$baseName}.${s}`:s,$$cache:{}}),i)),e.$$cache[t])},apply:(s,i,r)=>e.call("_.RemoteObject.apply",[t,s.$$baseName,r])},r={};s=new Proxy(Object.assign(()=>{},{$$cache:r,release$:()=>(Object.keys(r).forEach(e=>delete r[e]),e.call("_.RemoteObject.release",[t])),get$:()=>e.call("_.RemoteObject.get",[t])}),i)}e.resolve(s),clearTimeout(e.timeout),this._promises.delete(t.id)}}else this.sendError(new i("Parse error",-32700))}))}sendResult(e,t){const s={jsonrpc:"2.0",result:e||null};return t&&(s.id=t),this.send(s),this}sendError(e,t){const s={jsonrpc:"2.0",error:{code:e.code,message:e.message}};return t&&(s.id=t),this.send(s),this}notify(e,t={}){t=this.encodeFunctions(t),this.send({jsonrpc:"2.0",method:e,params:t})}call(e,t={}){t=this.encodeFunctions(t);let r=this;return new Promise((o,n)=>{let c=s.nanoid(),a={id:c,jsonrpc:"2.0",method:e,params:t};r.send(a),r._promises.set(c,{resolve:o,reject:n,timeout:setTimeout(()=>{r._promises.delete(c),n(new i(`Call ${e} Timeout`,-32603))},r._timeout)})})}on(e,t){return"string"!=typeof e?this._patterns.push({pattern:e,callback:t}):this._callings.set(e,t),this}off(e){if("string"!=typeof e){for(let t in this._callings.keys())null!=t.match(e)&&this._callings.delete(t);let t=e.toString();this._patterns=this._patterns.filter(({pattern:e})=>e.toString()!==t)}else this._callings.has(e)&&this._callings.delete(e);return this}}r.Error=i,exports.default=r;
//# sourceMappingURL=index.js.map
