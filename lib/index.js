"use strict";function e(e,t){var r,s;if(0===t.length)return e;for(r=0,s=t.length;r<s;r++)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e<0?-2*e:e}function t(r,s,n,i){var o,c=e(e(e(r,n),(o=s,Object.prototype.toString.call(o))),typeof s);if(null===s)return e(c,"null");if(void 0===s)return e(c,"undefined");if("object"==typeof s||"function"==typeof s){if(-1!==i.indexOf(s))return e(c,"[Circular]"+n);i.push(s);var l=function(e,r,s){return Object.keys(r).sort().reduce((function(e,n){return t(e,r[n],n,s)}),e)}(c,s,i);if(!("valueOf"in s)||"function"!=typeof s.valueOf)return l;try{return e(l,String(s.valueOf()))}catch(t){return e(l,"[valueOf exception]"+(t.stack||t.message))}}return e(c,s.toString())}Object.defineProperty(exports,"__esModule",{value:!0});var r=function(e){return function(e,t){for(;e.length<t;)e="0"+e;return e}(t(0,e,"",[]).toString(16),8)};const s=(n="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz",e=>{let t="",r=e;for(;r--;)t+=n[Math.random()*n.length|0];return t});var n;class i extends Error{constructor(e,t){super(e),this.code=t||0,this.message=e}toString(){return this.message}}class o{constructor(e,t){this._promises={},this._callingHandlers={},this._patterns=[],this._hashedFunctions={},this._remoteObjects={},this._remoteObjectClusters={},this.extendedRPCs=[],this.send=e,this._options=Object.assign({timeout:5e3},t||{}),this.on("_.Function.call",(e,t)=>{if(this._hashedFunctions.hasOwnProperty(e)){let r=this._hashedFunctions[e];return Promise.resolve(r(...t))}return Promise.resolve()}),this.on("_.Function.release",e=>{this._hashedFunctions.hasOwnProperty(e)&&delete this._hashedFunctions[e]}),this.on("_.RemoteObject.set",(e,t,r)=>{try{const s=this._remoteObjects[e],n=t.split("."),i=n.pop();let o=s;for(let e of n)o=Reflect.get(o,e);Reflect.set(o,i,r)}catch(e){console.debug(e)}}),this.on("_.RemoteObject.get",e=>{const t=this._remoteObjects[e];return Promise.resolve(t).then(e=>JSON.parse(JSON.stringify(e))).catch(e=>{console.debug("_.RemoteObject.get error",e)})}),this.on("_.RemoteObject.apply",(e,t,r)=>{const s=this._remoteObjects[e];let n,i;"$"===t.slice(-1)?(i=t.slice(0,-1).split("."),n=!0):(i=t.split("."),n=!1);const o=i.pop();let c=s;for(let e of i)c=Reflect.get(c,e);return Promise.resolve(Reflect.apply(c[o],c,r)).then(t=>n?JSON.parse(JSON.stringify(t)):this.makeRemoteObject(t,e))}),this.on("_.RemoteObject.release",e=>((this._remoteObjectClusters[e]||[]).map(e=>delete this._remoteObjects[e]),delete this._remoteObjectClusters[e],!0))}decodeNonScalars(e){const t=this,r=e=>{if(e===Object(e)){if("1.0"===e["@func"]&&Reflect.has(e,"hash"))return new Proxy(()=>{},{get(r,s){const n=String(s);return Reflect.has(r,s)?r[s]:"release"===n?()=>{t.notify("_.Function.release",[e.hash])}:void 0},apply(r,s,n){t.notify("_.Function.call",[e.hash,n])}});for(let t in e)e[t]=r(e[t])}else{if(Array.isArray(e))return e.map(e=>r(e));if(o.bufferDecode&&"string"==typeof e&&"@buf:"===e.slice(0,5))return o.bufferDecode(e.slice(5))}return e};return r(e)}encodeNonScalars(e){const t=e=>{if("function"==typeof e){let t=r(e);return this._hashedFunctions[t]=e,{"@func":"1.0",hash:t}}if(o.isBuffer&&o.bufferEncode&&o.isBuffer(e))return"@buf:"+o.bufferEncode(e);if(Array.isArray(e))return e.map(e=>t(e));if(Object(e)===e)for(let r in e)e[r]=t(e[r]);return e};return t(e)}makeRemoteObject(e,t){const r=s(16);this._remoteObjects[r]=e;const n=t||r,i=this._remoteObjectClusters[n]||[];return i.push(r),this._remoteObjectClusters[n]=i,{"@remote":r}}extends(e){this.extendedRPCs.push(e)}getHandler(e){if(this._callingHandlers.hasOwnProperty(e)){const t=this._callingHandlers[e];return t.once&&delete this._callingHandlers[e],[t.callback]}for(let t of this._patterns){const r=e.match(t.pattern);if(r)return[t.callback,r]}return[void 0]}receive(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return void this.sendError(new i("Parse error",-32700))}if("2.0"===e.jsonrpc){if(Reflect.has(e,"method")){let t,r=e.method,s=e.params;"$"===r.slice(-1)?(r=r.slice(0,-1),t=!0):t=!1;let[n,o]=this.getHandler(r);if(void 0===n&&this.extendedRPCs.length>0)for(let e of this.extendedRPCs)if([n,o]=e.getHandler(r),n)break;return void 0===n?void(e.id&&this.sendError(new i(`Method "${r}" not found`,-32601),e.id)):(s=this.decodeNonScalars(s),Array.isArray(s)||(s=[s]),o&&(s=[s,o]),Promise.resolve(n(...s)).then(r=>{t&&(r=this.makeRemoteObject(r)),e.id&&this.sendResult(r,e.id)}).catch(t=>{if(!(t instanceof i))throw t;this.sendError(t,e.id)}))}if(Reflect.has(e,"error")){if(e.id&&this._promises.hasOwnProperty(e.id)){let t=this._promises[e.id];t.reject(e.error),clearTimeout(t.timeout),delete this._promises[e.id]}}else if(Reflect.has(e,"result")&&e.id&&this._promises.hasOwnProperty(e.id)){let t=this._promises[e.id],r=e.result;if(r&&"object"==typeof r&&Reflect.has(r,"@remote")){const e=this,t=r["@remote"],s={set(r,s,n){const i=String(s),o=r.$$baseName?`${r.$$baseName}.${i}`:i;return e.call("_.RemoteObject.set",[t,o,n]),!0},get(e,t){const r=String(t);if("then"!==r&&"$$"!==r.slice(0,1))return Reflect.has(e,t)?e[t]:(Reflect.has(e.$$cache,t)||(e.$$cache[t]=new Proxy(Object.assign(()=>{},{$$baseName:e.$$baseName?`${e.$$baseName}.${r}`:r,$$cache:{}}),s)),e.$$cache[t])},apply:(r,s,n)=>e.call("_.RemoteObject.apply",[t,r.$$baseName,n])},n={};r=new Proxy(Object.assign(()=>{},{$$cache:n,release$:()=>(Object.keys(n).forEach(e=>delete n[e]),e.call("_.RemoteObject.release",[t])),get$:()=>e.call("_.RemoteObject.get",[t])}),s)}t.resolve(r),clearTimeout(t.timeout),delete this._promises[e.id]}return Promise.resolve()}this.sendError(new i("Parse error",-32700))}sendResult(e,t){const r={jsonrpc:"2.0",result:e||null};return t&&(r.id=t),this.send(r),this}sendError(e,t){const r={jsonrpc:"2.0",error:{code:e.code,message:e.message}};return t&&(r.id=t),this.send(r),this}notify(e,t={}){t=this.encodeNonScalars(t),this.send({jsonrpc:"2.0",method:e,params:t})}call(e,t={}){t=this.encodeNonScalars(t);let r=this;return new Promise((n,o)=>{let c=s(8),l={id:c,jsonrpc:"2.0",method:e,params:t};r.send(l),r._promises[c]={resolve:n,reject:o,timeout:setTimeout(()=>{delete r._promises[c],o(new i(`Call ${e} Timeout`,-32603))},r._options.timeout)}})}once(e,t){return this.on(e,t,!0)}on(e,t,r=!1){return"string"!=typeof e?this._patterns.push({pattern:e,callback:t}):this._callingHandlers[e]={callback:t,once:r},this}off(e){if("string"!=typeof e){for(let t in this._callingHandlers)null!=t.match(e)&&delete this._callingHandlers[t];let t=e.toString();this._patterns=this._patterns.filter(e=>e.pattern.toString()!==t)}else delete this._callingHandlers[e];return this}}o.Error=i,Object.assign(o,{isBuffer:e=>Buffer.isBuffer(e),bufferEncode:e=>e.toString("base64"),bufferDecode:e=>Buffer.from(e,"base64")}),exports.RPC=o,exports.RPCError=i,exports.default=o;
//# sourceMappingURL=index.js.map
