"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var nanoid=_interopDefault(require("nanoid/non-secure")),hash_sum=_interopDefault(require("hash-sum")),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function __awaiter(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new r((function(t){t(e.value)})).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function __generator(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var RPCError=function(e){function t(t,r){var n=e.call(this)||this;return n.code=r||0,n.message=t,n}return __extends(t,e),t.prototype.toString=function(){return this.message},t}(Error),HASHED_FUNCTIONS=new Map,REMOTE_OBJECTS=new Map,REMOTE_OBJECT_CLUSTERS=new Map,RPC=function(){function e(e,t){var r=this;void 0===t&&(t=5e3),this._timeout=5e3,this._promises=new Map,this._callings=new Map,this._patterns=[],this.extendedRPCs=[],this.send=e,this._timeout=t||5e3,this.on("_.Function.call",(function(e,t){return __awaiter(r,void 0,void 0,(function(){var r;return __generator(this,(function(n){switch(n.label){case 0:return HASHED_FUNCTIONS.has(e)?(r=HASHED_FUNCTIONS.get(e),[4,Promise.resolve(r.apply(void 0,t))]):[3,2];case 1:return[2,n.sent()];case 2:return[2]}}))}))})),this.on("_.RemoteObject.set",(function(e,t,r){try{for(var n=REMOTE_OBJECTS.get(e),o=t.split("."),i=o.pop(),s=n,a=0,c=o;a<c.length;a++){var u=c[a];s=Reflect.get(s,u)}Reflect.set(s,i,r)}catch(e){console.debug(e)}})),this.on("_.RemoteObject.get",(function(e){return __awaiter(r,void 0,void 0,(function(){var t,r,n,o,i,s;return __generator(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),t=REMOTE_OBJECTS.get(e),n=(r=JSON).parse,i=(o=JSON).stringify,[4,Promise.resolve(t)];case 1:return[2,n.apply(r,[i.apply(o,[a.sent()])])];case 2:return s=a.sent(),console.debug(s),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.apply",(function(e,t,n){return __awaiter(r,void 0,void 0,(function(){var r,o,i,s,a,c,u,l,f;return __generator(this,(function(h){switch(h.label){case 0:for(h.trys.push([0,2,,3]),r=REMOTE_OBJECTS.get(e),o=void 0,i=void 0,"$"===t.slice(-1)?(i=t.slice(0,-1).split("."),o=!0):(i=t.split("."),o=!1),s=i.pop(),a=r,c=0,u=i;c<u.length;c++)l=u[c],a=Reflect.get(a,l);return[4,Promise.resolve(Reflect.apply(a[s],a,n))];case 1:return f=h.sent(),o?[2,JSON.parse(JSON.stringify(f))]:[2,this.makeRemoteObject(f,e)];case 2:return h.sent(),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.release",(function(e){return(REMOTE_OBJECT_CLUSTERS.get(e)||[]).map((function(e){return REMOTE_OBJECTS.delete(e)})),REMOTE_OBJECT_CLUSTERS.delete(e),!0}))}return e.prototype.decodeFunctions=function(e){var t=this,r=function(e){if(e===Object(e)){if("1.0"===e["@func"]&&Reflect.has(e,"hash"))return new Proxy((function(){}),{apply:function(r,n,o){t.notify("_.Function.call",[e.hash,o])}});for(var n in e)e.hasOwnProperty(n)&&(e[n]=r(e[n]))}else if(Array.isArray(e))return e.map((function(e){return r(e)}));return e};return r(e)},e.prototype.encodeFunctions=function(e){var t=function(e){if("function"==typeof e){var r=hash_sum(e);return HASHED_FUNCTIONS.set(r,e),{"@func":"1.0",hash:r}}if(e===Object(e))for(var n in e)e.hasOwnProperty(n)&&(e[n]=t(e[n]));else if(Array.isArray(e))return e.map((function(e){return t(e)}));return e};return t(e)},e.prototype.makeRemoteObject=function(e,t){var r=nanoid();REMOTE_OBJECTS.set(r,e);var n=t||r,o=REMOTE_OBJECT_CLUSTERS.get(n)||[];return o.push(r),REMOTE_OBJECT_CLUSTERS.set(n,o),{"@remote":r}},e.prototype.extends=function(e){this.extendedRPCs.push(e)},e.prototype.getHandler=function(e){var t,r;if(this._callings.has(e))t=this._callings.get(e);else for(var n=0,o=this._patterns;n<o.length;n++){var i=o[n],s=i.pattern,a=i.callback;if(r=e.match(s)){t=a;break}}return[t,r]},e.prototype.receive=function(e){return __awaiter(this,void 0,void 0,(function(){var t,r,n,o,i,s,a,c,u,l,f,h,p,d,_,m,y;return __generator(this,(function(v){switch(v.label){case 0:if("2.0"!==e.jsonrpc)return[2,!1];if(!Reflect.has(e,"method"))return[3,5];if(t=e.method,r=e.params,n=void 0,"$"===t.slice(-1)?(t=t.slice(0,-1),n=!0):n=!1,o=this.getHandler(t),i=o[0],s=o[1],void 0===i&&this.extendedRPCs.length>0)for(a=0,c=this.extendedRPCs;a<c.length&&(u=c[a],y=u.getHandler(t),i=y[0],s=y[1],!i);a++);if(void 0===i)return e.id&&this.sendError(new RPCError('Method "'+t+'" not found',-32601),e.id),[2];r=this.decodeFunctions(r),Array.isArray(r)||(r=[r]),v.label=1;case 1:return v.trys.push([1,3,,4]),h=void 0,s&&(r=[r,s]),[4,Promise.resolve(i.apply(void 0,r))];case 2:return h=v.sent(),n&&(h=this.makeRemoteObject(h)),e.id?[2,this.sendResult(h,e.id)]:[3,4];case 3:if((l=v.sent())instanceof RPCError)return[2,this.sendError(l)];throw l;case 4:return[3,6];case 5:Reflect.has(e,"error")?e.id&&this._promises.has(e.id)&&((f=this._promises.get(e.id)).reject(e.error),clearTimeout(f.timeout),this._promises.delete(e.id)):Reflect.has(e,"result")&&e.id&&this._promises.has(e.id)&&(f=this._promises.get(e.id),(h=e.result)&&"object"==typeof h&&Reflect.has(h,"@remote")&&(p=this,d=h["@remote"],_={set:function(e,t,r){var n=String(t),o=e.$$baseName?e.$$baseName+"."+n:n;return p.call("_.RemoteObject.set",[d,o,r]),!0},get:function(e,t){var r=String(t);if("then"!==r&&"$$"!==r.slice(0,1))return Reflect.has(e,t)?e[t]:(Reflect.has(e.$$cache,t)||(e.$$cache[t]=new Proxy(Object.assign((function(){}),{$$baseName:e.$$baseName?e.$$baseName+"."+r:r,$$cache:{}}),_)),e.$$cache[t])},apply:function(e,t,r){return p.call("_.RemoteObject.apply",[d,e.$$baseName,r])}},m={},h=new Proxy(Object.assign((function(){}),{$$cache:m,release$:function(){return Object.keys(m).forEach((function(e){return delete m[e]})),p.call("_.RemoteObject.release",[d])},get$:function(){return p.call("_.RemoteObject.get",[d])}}),_)),f.resolve(h),clearTimeout(f.timeout),this._promises.delete(e.id)),v.label=6;case 6:return[2]}}))}))},e.prototype.sendResult=function(e,t){var r={jsonrpc:"2.0",result:e||null};return t&&(r.id=t),this.send(r),this},e.prototype.sendError=function(e,t){var r={jsonrpc:"2.0",error:{code:e.code,message:e.message}};return t&&(r.id=t),this.send(r),this},e.prototype.notify=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t),this.send({jsonrpc:"2.0",method:e,params:t})},e.prototype.call=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t);var r=this;return new Promise((function(n,o){var i=nanoid(),s={id:i,jsonrpc:"2.0",method:e,params:t};r.send(s),r._promises.set(i,{resolve:n,reject:o,timeout:setTimeout((function(){r._promises.delete(i),o(new RPCError("Call "+e+" Timeout",-32603))}),r._timeout)})}))},e.prototype.on=function(e,t){return"string"!=typeof e?this._patterns.push({pattern:e,callback:t}):this._callings.set(e,t),this},e.prototype.off=function(e){if("string"!=typeof e){for(var t in this._callings.keys())null!=t.match(e)&&this._callings.delete(t);var r=e.toString();this._patterns=this._patterns.filter((function(e){return e.pattern.toString()!==r}))}else this._callings.has(e)&&this._callings.delete(e);return this},e.Error=RPCError,e}();module.exports=RPC;
