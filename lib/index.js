"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var nanoid=_interopDefault(require("nanoid/non-secure")),hash_sum=_interopDefault(require("hash-sum")),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function __extends(e,t){function n(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function __awaiter(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){e.done?i(e.value):new n((function(t){t(e.value)})).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function __generator(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var RPCError=function(e){function t(t,n){var r=e.call(this)||this;return r.code=n||0,r.message=t,r}return __extends(t,e),t.prototype.toString=function(){return this.message},t}(Error),HASHED_FUNCTIONS=new Map,REMOTE_OBJECTS=new Map,REMOTE_OBJECT_CLUSTERS=new Map,RPC=function(){function e(e,t){var n=this;void 0===t&&(t=5e3),this._timeout=5e3,this._promises=new Map,this._callings=new Map,this._patterns=[],this.extendedRPCs=[],this.send=e,this._timeout=t||5e3,this.on("_.Function.call",(function(e,t){return __awaiter(n,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return HASHED_FUNCTIONS.has(e)?[4,HASHED_FUNCTIONS.get(e).apply(void 0,t)]:[3,2];case 1:return[2,n.sent()||null];case 2:return[2]}}))}))})),this.on("_.RemoteObject.get",(function(e,t){return __awaiter(n,void 0,void 0,(function(){var n,r,i;return __generator(this,(function(o){switch(o.label){case 0:for(i in o.trys.push([0,2,,3]),n=REMOTE_OBJECTS.get(e),r=n,t.split("."))r=r[i];return[4,r];case 1:return[2,o.sent()];case 2:return o.sent(),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.set",(function(e,t,n){try{var r=REMOTE_OBJECTS.get(e),i=t.split("."),o=i.pop(),s=r;for(var a in i)s=s[a];s[o]=n}catch(e){}})),this.on("_.RemoteObject.apply",(function(e,t,r){return __awaiter(n,void 0,void 0,(function(){var n,i,o,s;return __generator(this,(function(a){switch(a.label){case 0:for(o in a.trys.push([0,2,,3]),n=REMOTE_OBJECTS.get(e),i=n,t.split("."))i=i[o];return[4,i.apply(void 0,r)];case 1:return s=a.sent(),[2,this.makeRemoteObject(s,e)];case 2:return a.sent(),[3,3];case 3:return[2]}}))}))})),this.on("_.RemoteObject.release",(function(e){return(REMOTE_OBJECT_CLUSTERS.get(e)||[]).map((function(e){return REMOTE_OBJECTS.delete(e)})),REMOTE_OBJECT_CLUSTERS.delete(e),!0}))}return e.prototype.decodeFunctions=function(e){var t=this,n=function(e){if(e===Object(e)){if("1.0"===e["@func"]&&"hash"in e)return new Proxy((function(){}),{apply:function(n,r,i){t.notify("_.Function.call",[e.hash,i])}});for(var r in e)e.hasOwnProperty(r)&&(e[r]=n(e[r]))}else if(Array.isArray(e))return e.map((function(e){return n(e)}));return e};return n(e)},e.prototype.encodeFunctions=function(e){var t=function(e){if("function"==typeof e){var n=hash_sum(e);return HASHED_FUNCTIONS.set(n,e),{"@func":"1.0",hash:n}}if(e===Object(e))for(var r in e)e.hasOwnProperty(r)&&(e[r]=t(e[r]));else if(Array.isArray(e))return e.map((function(e){return t(e)}));return e};return t(e)},e.prototype.makeRemoteObject=function(e,t){var n=nanoid();REMOTE_OBJECTS.set(n,e);var r=t||n,i=REMOTE_OBJECT_CLUSTERS.get(r)||[];return i.push(n),REMOTE_OBJECT_CLUSTERS.set(r,i),{"@remote":n}},e.prototype.extends=function(e){this.extendedRPCs.push(e)},e.prototype.getHandler=function(e){var t,n;if(this._callings.has(e))t=this._callings.get(e);else for(var r=0,i=this._patterns;r<i.length;r++){var o=i[r],s=o.pattern,a=o.callback;if(n=e.match(s)){t=a;break}}return[t,n]},e.prototype.receive=function(e){return __awaiter(this,void 0,void 0,(function(){var t,n,r,i,o,s,a,c,u,l,h,f,p,d,_,m;return __generator(this,(function(y){switch(y.label){case 0:if("2.0"!==e.jsonrpc)return[2,!1];if(!("method"in e))return[3,8];if(t=e.method,n=e.params,r=void 0,"$"===t.slice(-1)?(t=t.slice(0,-1),r=!0):r=!1,i=this.getHandler(t),o=i[0],s=i[1],void 0===o&&this.extendedRPCs.length>0)for(a=0,c=this.extendedRPCs;a<c.length&&(u=c[a],m=u.getHandler(t),o=m[0],s=m[1],!o);a++);if(void 0===o)return[2,this.sendError(new RPCError('Method "'+t+'" not found',-32601),e.id)];n=this.decodeFunctions(n),Array.isArray(n)||(n=[n]),y.label=1;case 1:return y.trys.push([1,6,,7]),f=void 0,s?[4,o(n,s)]:[3,3];case 2:return f=y.sent()||null,[3,5];case 3:return[4,o.apply(void 0,n)];case 4:f=y.sent()||null,y.label=5;case 5:return r&&(f=this.makeRemoteObject(f)),e.id?[2,this.sendResult(f,e.id)]:[3,7];case 6:if((l=y.sent())instanceof RPCError)return[2,this.sendError(l)];throw l;case 7:return[3,9];case 8:"error"in e?e.id&&this._promises.has(e.id)&&((h=this._promises.get(e.id)).reject(e.error),clearTimeout(h.timeout),this._promises.delete(e.id)):"result"in e&&e.id&&this._promises.has(e.id)&&(h=this._promises.get(e.id),(f=e.result)&&"object"==typeof f&&f["@remote"]&&(p=this,d=f["@remote"],_={set:function(e,t,n){return p.call("_.RemoteObject.set",[d,e.$$baseName+"/"+String(t),n]),!0},get:function(e,t){if("$$"!=String(t).slice(0,1))return t in e?e[t]:(t in e.$cache||(e.$$cache[t]=new Proxy(Object.assign((function(){}),{$$baseName:e.$$baseName+"."+String(t),$$cache:{},get $(){return p.call("_.RemoteObject.get",[d,e.$$baseName])}}),_)),e.$$cache[t])},apply:function(e,t,n){return p.call("_.RemoteObject.apply",[d,e.$$baseName,n])}},f=new Proxy({$$baseName:"",$$cache:{},release$:function(){return p.call("_.RemoteObject.release",[d])}},_)),h.resolve(f),clearTimeout(h.timeout),this._promises.delete(e.id)),y.label=9;case 9:return[2]}}))}))},e.prototype.sendResult=function(e,t){var n={jsonrpc:"2.0",result:e};return t&&(n.id=t),this.send(n),this},e.prototype.sendError=function(e,t){var n={jsonrpc:"2.0",error:{code:e.code,message:e.message}};return t&&(n.id=t),this.send(n),this},e.prototype.notify=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t),this.send({jsonrpc:"2.0",method:e,params:t})},e.prototype.call=function(e,t){void 0===t&&(t={}),t=this.encodeFunctions(t);var n=this;return new Promise((function(r,i){var o=nanoid(),s={id:o,jsonrpc:"2.0",method:e,params:t};n.send(s),n._promises.set(o,{resolve:r,reject:i,timeout:setTimeout((function(){n._promises.delete(o),i(new RPCError("Call "+e+" Timeout",-32603))}),n._timeout)})}))},e.prototype.on=function(e,t){return"string"!=typeof e?this._patterns.push({pattern:e,callback:t}):this._callings.set(e,t),this},e.prototype.off=function(e){if("string"!=typeof e){for(var t in this._callings.keys())null!=t.match(e)&&this._callings.delete(t);var n=e.toString();this._patterns=this._patterns.filter((function(e){return e.pattern.toString()!==n}))}else this._callings.has(e)&&this._callings.delete(e);return this},e.Error=RPCError,e}();module.exports=RPC;
